name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ ! "$PR_TITLE" =~ ^(\[FEATURE\]|\[BUG\]|\[FIX\]|\[DOCS\]|\[REFACTOR\]|\[TEST\]|\[CHORE\]) ]]; then
            echo "Warning: PR title should start with [FEATURE], [BUG], [FIX], [DOCS], [REFACTOR], [TEST], or [CHORE]"
          fi

      - name: Check for description
        run: |
          BODY="${{ github.event.pull_request.body }}"
          if [ -z "$BODY" ] || [ ${#BODY} -lt 20 ]; then
            echo "Error: PR description is too short or missing"
            exit 1
          fi

      - name: Verify files changed
        run: |
          FILES_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          echo "Files changed:"
          echo "$FILES_CHANGED"

  build-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Preview build
        run: npm run preview &
        timeout-minutes: 1

  size-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build and check size
        run: |
          npm run build
          DIST_SIZE=$(du -sh dist | cut -f1)
          echo "Build size: $DIST_SIZE"

  security-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run npm audit
        run: npm audit --audit-level=moderate || echo "Security check completed with warnings"
